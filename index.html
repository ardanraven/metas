<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal de Metas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .progress-bar { transition: width 400ms ease; }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4f46e5;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div id="login-view" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4">
    <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-lg">
      <div>
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          Portal de Metas
        </h2>
      </div>
      <form id="login-form" class="mt-8 space-y-6">
        <div class="rounded-md shadow-sm -space-y-px">
          <input id="login-email" type="email" autocomplete="email" required class="appearance-none rounded-t-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Seu email">
          <input id="login-password" type="password" autocomplete="current-password" required class="appearance-none rounded-b-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Sua senha">
        </div>
        <p id="login-error" class="text-sm text-red-600 mt-2"></p>
        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          Acessar
        </button>
      </form>
    </div>
  </div>

  <div id="app-view" class="max-w-7xl mx-auto p-4 sm:p-6 hidden">
    <header class="mb-6 flex flex-wrap justify-between items-center">
      <div>
        <h1 id="header-title" class="text-2xl md:text-3xl font-semibold tracking-tight"></h1>
        <p id="user-info" class="text-sm text-slate-500">Carregando...</p>
      </div>
      <button id="logout-btn" class="px-4 py-2 mt-2 md:mt-0 rounded-xl bg-rose-600 text-white text-sm hover:bg-rose-700">Sair</button>
    </header>

    <div id="app-loader" class="flex flex-col justify-center items-center py-10 bg-white rounded-2xl shadow">
      <div class="loader"></div>
      <p id="loader-message" class="mt-4 text-slate-600">Verificando credenciais...</p>
    </div>
    
    <div id="admin-dashboard" class="hidden space-y-6">
        
       <section id="admin-store-view-container" class="bg-white rounded-2xl shadow p-5">
            <h2 class="text-lg font-semibold">Visualizar Desempenho da Loja</h2>
            <p class="text-sm text-slate-500">Selecione uma loja para ver seus KPIs, gráficos e vendedores (usando o mesmo painel do supervisor).</p>
            <select id="admin-store-selector" class="mt-3 block w-full max-w-xs pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                <option value="">Selecione uma loja...</option>
                <option value="24info">24info</option>
                <option value="MegaMusica">MegaMusica</option>
                <option value="Data">Data</option>
                <option value="MegaInfo">MegaInfo</option>
            </select>
       </section>

       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow p-5 sticky top-6">
                <h2 id="admin-form-title" class="text-lg font-semibold">Criar Novo Usuário</h2>
                <form id="create-user-form" class="mt-4 space-y-4">
                    <input type="hidden" id="admin-edit-uid">
                    <div>
                        <label for="admin-userName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="admin-userName" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="admin-userEmail" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="admin-userEmail" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-gray-100">
                    </div>
                    <div>
                        <label for="admin-userPassword" class="block text-sm font-medium text-gray-700">Senha Provisória</label>
                        <input type="password" id="admin-userPassword" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-gray-100 disabled:placeholder-gray-400" placeholder="Senha de 6+ dígitos">
                    </div>
                    <div>
                        <label for="admin-userRole" class="block text-sm font-medium text-gray-700">Função</label>
                        <select id="admin-userRole" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="seller">Vendedor(a)</option>
                            <option value="supervisor">Supervisor(a)</option>
                        </select>
                    </div>
                    <div>
                        <label for="admin-userStore" class="block text-sm font-medium text-gray-700">Loja</label>
                        <select id="admin-userStore" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">Selecione a loja</option>
                            <option value="24info">24info</option>
                            <option value="MegaMusica">MegaMusica</option>
                            <option value="Data">Data</option>
                            <option value="MegaInfo">MegaInfo</option>
                        </select>
                    </div>
                    <div id="admin-supervisor-selector-div" class="hidden">
                        <label for="admin-userSupervisor" class="block text-sm font-medium text-gray-700">Supervisor Responsável</label>
                        <select id="admin-userSupervisor" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">Primeiro, selecione a loja</option>
                        </select>
                    </div>
                    <p id="admin-form-feedback" class="text-sm"></p>
                    <button type="submit" id="admin-create-user-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Criar Conta
                    </button>
                    <button type="button" id="admin-cancel-edit-btn" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 hidden">
                    Cancelar Edição
                    </button>
                </form>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow p-5">
                    <h2 class="text-lg font-semibold">Usuários Cadastrados</h2>
                    <div class="overflow-x-auto mt-3">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-slate-100">
                        <tr>
                            <th class="p-3 font-medium">Nome</th>
                            <th class="p-3 font-medium">Email</th>
                            <th class="p-3 font-medium">Função</th>
                            <th class="p-3 font-medium">Loja</th>
                            <th class="p-3 font-medium">Ações</th>
                        </tr>
                        </thead>
                        <tbody id="admin-users-table">
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="supervisor-dashboard" class="hidden space-y-6">
        <section class="bg-white rounded-2xl shadow p-5 grid md:grid-cols-2 gap-6">
            <div>
                <h2 class="text-lg font-semibold">Gerenciar Meta da Loja</h2>
                <div class="mt-3 flex items-center gap-4 flex-wrap">
                    <div class="flex-grow">
                        <label for="sup-meta-loja-input" class="block text-sm font-medium text-gray-700">Meta do Mês (R$)</label>
                        <input id="sup-meta-loja-input" type="number" placeholder="Ex: 500000" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="sup-save-meta-loja" class="px-5 py-2 mt-6 rounded-xl bg-emerald-600 text-white text-sm hover:bg-emerald-700 self-end">Salvar Meta</button>
                </div>
                <p id="sup-meta-feedback" class="text-sm mt-2"></p>
            </div>
             <div>
                <h2 class="text-lg font-semibold">Ações do Mês</h2>
                <p class="text-xs text-slate-500 mt-1">Esta ação arquivará os resultados atuais e irá zerar as vendas de todos os vendedores para iniciar um novo mês.</p>
                <button id="sup-close-month-btn" class="w-full mt-4 px-5 py-2 rounded-xl bg-red-600 text-white text-sm hover:bg-red-700">Fechar e Arquivar Mês Atual</button>
             </div>
        </section>

        <section class="grid md:grid-cols-4 gap-6">
            <div class="bg-white rounded-2xl shadow p-5">
                <p class="text-sm text-slate-500">Meta da Loja</p>
                <p id="sup-kpi-meta-loja" class="text-2xl font-semibold">R$ 0,00</p>
            </div>
            <div class="bg-white rounded-2xl shadow p-5">
                <p class="text-sm text-slate-500">Meta Total da Equipe</p>
                <p id="sup-kpi-meta-equipe" class="text-2xl font-semibold">R$ 0,00</p>
            </div>
            <div class="bg-white rounded-2xl shadow p-5">
                <p class="text-sm text-slate-500">Vendido Total (mês)</p>
                <p id="sup-kpi-vendido-total" class="text-2xl font-semibold text-green-600">R$ 0,00</p>
            </div>
            <div class="bg-white rounded-2xl shadow p-5">
                <p class="text-sm text-slate-500">Progresso Geral</p>
                <p id="sup-kpi-progresso-total" class="text-2xl font-semibold">0%</p>
            </div>
        </section>

        <section class="bg-white rounded-2xl shadow p-5">
            <h2 class="text-lg font-semibold">Desempenho de Vendas da Equipe (Mês Atual)</h2>
            <div class="h-96 mt-4"><canvas id="storeChart"></canvas></div>
        </section>

        <section class="bg-white rounded-2xl shadow p-5">
            <h2 class="text-lg font-semibold">Desempenho por Vendedor (Mês Atual)</h2>
            <p class="text-xs text-slate-500">Clique em um vendedor para ver seu gráfico individual.</p>
            <div class="overflow-x-auto mt-3">
            <table class="min-w-full text-sm text-left">
                <thead class="bg-slate-100">
                <tr>
                    <th class="p-3 font-medium">Vendedor(a)</th>
                    <th class="p-3 font-medium text-right">Meta (R$)</th>
                    <th class="p-3 font-medium text-right">Vendido (R$)</th>
                    <th class="p-3 font-medium">Progresso</th>
                </tr>
                </thead>
                <tbody id="sellers-table-body"></tbody>
            </table>
            </div>
        </section>

        <section class="bg-white rounded-2xl shadow p-5">
            <h2 class="text-lg font-semibold">Histórico de Meses Fechados</h2>
            <div id="history-table-container" class="overflow-x-auto mt-3">
                </div>
        </section>
    </div>

    <div id="seller-dashboard" class="hidden space-y-6">
      <section class="bg-blue-800 text-white rounded-2xl shadow p-5 text-center">
        <p class="text-sm opacity-80">Meta da Loja</p>
        <p id="seller-kpi-meta-loja" class="text-3xl font-bold tracking-tight">R$ 0,00</p>
      </section>
      
      <section class="bg-white rounded-2xl shadow p-5 grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium">Sua meta do mês (R$)</label>
          <input id="seller-meta-mes" type="number" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium">Dias no mês</label>
          <input id="seller-dias-mes" type="number" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium">Dia atual do mês</label>
          <input id="seller-dia-atual" type="number" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="md:col-span-3">
          <button id="seller-save-cfg" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm hover:bg-emerald-700">Salvar minhas configurações</button>
        </div>
      </section>

      <section class="grid md:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl shadow p-5"><p class="text-xs text-slate-500">Sua meta diária</p><p id="seller-kpi-meta-diaria" class="text-xl font-semibold">R$ 0,00</p></div>
        <div class="bg-white rounded-2xl shadow p-5"><p class="text-xs text-slate-500">Vendido até agora</p><p id="seller-kpi-vendido" class="text-xl font-semibold">R$ 0,00</p></div>
        <div class="bg-white rounded-2xl shadow p-5"><p class="text-xs text-slate-500">Necessário por dia</p><p id="seller-kpi-necessario" class="text-xl font-semibold">R$ 0,00</p></div>
        <div class="bg-white rounded-2xl shadow p-5"><p class="text-xs text-slate-500">Seu Ritmo × Ideal</p><p id="seller-kpi-ritmo" class="text-xl font-semibold">R$ 0,00</p></div>
      </section>

      <section class="bg-white rounded-2xl shadow p-5">
        <div class="flex items-center justify-between"><p class="text-sm font-medium">Progresso da sua meta</p><p id="seller-kpi-progresso" class="text-sm font-semibold">0%</p></div>
        <div class="w-full h-3 bg-slate-200 rounded-full mt-2"><div id="seller-progress-fill" class="h-3 bg-indigo-600 rounded-full progress-bar" style="width:0%"></div></div>
      </section>

       <section class="bg-white rounded-2xl shadow p-5 grid md:grid-cols-3 gap-6">
        <div class="md:col-span-1">
          <h2 class="text-lg font-semibold">Registrar venda</h2>
          <div class="mt-3 space-y-3">
            <input id="seller-sale-date" type="date" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <input id="seller-sale-amount" type="number" placeholder="Valor (R$)" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <button id="seller-add-sale" class="w-full px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-700">Adicionar Venda</button>
          </div>
        </div>
        <div class="md-col-span-2">
          <h2 class="text-lg font-semibold">Vendas lançadas</h2>
          <div class="max-h-60 overflow-y-auto mt-3">
            <table class="min-w-full text-sm"><thead class="sticky top-0 bg-slate-100"><tr><th class="text-left p-2 font-medium">Data</th><th class="text-right p-2 font-medium">Valor (R$)</th><th class="p-2"></th></tr></thead><tbody id="seller-sales-table"></tbody></table>
          </div>
        </div>
      </section>
      
      <section class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-lg font-semibold">Seu Desempenho de Vendas (Acumulado)</h2>
        <div class="h-96 mt-4"><canvas id="sellerChart"></canvas></div>
      </section>
    </div>
  </div>

  <div id="chart-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
      <div class="bg-white rounded-2xl shadow-xl p-5 w-full max-w-4xl relative">
          <button id="modal-close-btn" class="absolute top-3 right-4 text-3xl font-light text-gray-500 hover:text-gray-800">&times;</button>
          <h2 id="modal-chart-title" class="text-xl font-semibold mb-4">Desempenho</h2>
          <div class="h-96">
              <canvas id="modalChartCanvas"></canvas>
          </div>
      </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    // ATUALIZADO: Importar 'sendPasswordResetEmail'
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, onSnapshot, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAVEpjwrF4t_Z1MPt5hR1YYuEv2-x7rQqk",
      authDomain: "painel-metas-6cb79.firebaseapp.com",
      projectId: "painel-metas-6cb79",
      storageBucket: "painel-metas-6cb79.firebasestorage.app",
      messagingSenderId: "980825522055",
      appId: "1:980825522055:web:d1f1f5609ed0e1c9079d22"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // --- LÓGICA GERAL E AUTENTICAÇÃO ---
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const appLoader = document.getElementById('app-loader');
    const adminDashboard = document.getElementById('admin-dashboard');
    const supervisorDashboard = document.getElementById('supervisor-dashboard');
    const sellerDashboard = document.getElementById('seller-dashboard');

    const fmtBRL = (v) => (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    let unsubscribeSalesListener = null;
    let unsubscribeStoreListener = null;
    let unsubscribeHistoryListener = null;
    let unsubscribeAdminUsersListener = null;

    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      document.getElementById('login-error').textContent = '';
      signInWithEmailAndPassword(auth, email, password)
        .catch(error => { document.getElementById('login-error').textContent = 'Email, senha ou permissão inválidos.'; });
    });

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, user => {
      if (user) {
        loginView.classList.add('hidden');
        appView.classList.remove('hidden');
        loadUserData(user);
      } else {
        loginView.classList.remove('hidden');
        appView.classList.add('hidden');
        if(unsubscribeSalesListener) unsubscribeSalesListener();
        if(unsubscribeStoreListener) unsubscribeStoreListener();
        if(unsubscribeHistoryListener) unsubscribeHistoryListener();
        if(unsubscribeAdminUsersListener) unsubscribeAdminUsersListener();
      }
    });

    async function loadUserData(user) {
        try {
            appLoader.classList.remove('hidden');
            [adminDashboard, supervisorDashboard, sellerDashboard].forEach(d => d.classList.add('hidden'));

            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (!userDoc.exists()) {
                document.getElementById('loader-message').textContent = "Dados de usuário não encontrados. Contate o admin.";
                signOut(auth);
                return;
            }

            const userData = userDoc.data();
            
            if (userData.role === 'admin') {
                document.getElementById('header-title').textContent = 'Painel Administrativo';
                document.getElementById('user-info').textContent = `Admin: ${userData.name}`;
                loadAdminDashboard();
            } else {
                if (!userData.storeId) {
                    document.getElementById('loader-message').textContent = "Usuário sem loja associada. Contate o admin.";
                    signOut(auth);
                    return;
                }
                document.getElementById('user-info').textContent = `${userData.name} (${userData.storeId})`;
                if(unsubscribeStoreListener) unsubscribeStoreListener();
                unsubscribeStoreListener = onSnapshot(doc(db, 'stores', userData.storeId), (storeDoc) => {
                    const storeData = storeDoc.exists() ? storeDoc.data() : { storeGoal: 0 };
                    if (userData.role === 'supervisor') {
                        document.getElementById('header-title').textContent = 'Painel do Supervisor';
                        loadSupervisorDashboard(user.uid, userData.storeId, storeData);
                    } else if (userData.role === 'seller') {
                        document.getElementById('header-title').textContent = 'Painel do Vendedor';
                        loadSellerDashboard(user.uid, storeData);
                    }
                });
            }
        } catch (error) {
            console.error("Erro ao carregar dados do usuário:", error);
            document.getElementById('loader-message').textContent = "Ocorreu um erro ao carregar seus dados.";
            signOut(auth);
        }
    }
    
    // --- LÓGICA DO PAINEL ADMINISTRATIVO ---
    let allSupervisors = [];
    let allUsers = []; // NOVO: Armazena todos os usuários para edição

    function loadAdminDashboard() {
        adminDashboard.classList.remove('hidden');
        appLoader.classList.add('hidden');
        
        const usersRef = collection(db, "users");
        if(unsubscribeAdminUsersListener) unsubscribeAdminUsersListener();
        unsubscribeAdminUsersListener = onSnapshot(usersRef, (snapshot) => {
            allUsers = []; // Limpa a lista
            allSupervisors = [];
            snapshot.forEach(doc => {
              const userData = { id: doc.id, ...doc.data() };
              allUsers.push(userData); // Adiciona na lista geral
              if (userData.role === 'supervisor') {
                  allSupervisors.push(userData);
              }
            });
            renderAdminUsersTable(allUsers); // Renderiza todos os usuários
            updateAdminSupervisorDropdown(); 
        });

        setupAdminFormListeners();
        setupAdminStoreView(); // NOVO: Configura o seletor de lojas

        // NOVO: Listener de eventos na tabela para botões de ação
        document.getElementById('admin-users-table').addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-user-btn')) {
                const uid = e.target.dataset.uid;
                prepareEditForm(uid);
            }
            if (e.target.classList.contains('reset-pass-btn')) {
                const email = e.target.dataset.email;
                handlePasswordReset(email);
            }
        });
    }

    function renderAdminUsersTable(users) {
        const tableBody = document.getElementById('admin-users-table');
        tableBody.innerHTML = '';
        users.forEach(user => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-slate-200';
            tr.innerHTML = `
                <td class="p-3">${user.name || 'N/A'}</td>
                <td class="p-3">${user.email}</td>
                <td class="p-3 capitalize">${user.role === 'seller' ? 'Vendedor(a)' : user.role}</td>
                <td class="p-3">${user.storeId || 'N/A'}</td>
                <td class="p-3 whitespace-nowrap">
                    <button class="text-sm text-blue-600 hover:underline edit-user-btn" data-uid="${user.id}">Editar</button>
                    <button class="text-sm text-red-600 hover:underline ml-2 reset-pass-btn" data-email="${user.email}">Resetar Senha</button>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    }
    
    function setupAdminFormListeners() {
      const roleSelect = document.getElementById('admin-userRole');
      const storeSelect = document.getElementById('admin-userStore');
      const supervisorDiv = document.getElementById('admin-supervisor-selector-div');

      function handleRoleOrStoreChange() {
        const isSeller = roleSelect.value === 'seller';
        supervisorDiv.classList.toggle('hidden', !isSeller);
        if (isSeller) {
          updateAdminSupervisorDropdown();
        }
      }

      roleSelect.addEventListener('change', handleRoleOrStoreChange);
      storeSelect.addEventListener('change', handleRoleOrStoreChange);
      
      // ATUALIZADO: O submit agora chama 'handleSaveUser'
      document.getElementById('create-user-form').addEventListener('submit', handleSaveUser);
      // NOVO: Botão de cancelar edição
      document.getElementById('admin-cancel-edit-btn').addEventListener('click', resetAdminForm);
      
      handleRoleOrStoreChange();
    }
    
    // NOVO: Configura o seletor de lojas do Admin
    function setupAdminStoreView() {
        document.getElementById('admin-store-selector').addEventListener('change', async (e) => {
            const storeId = e.target.value;
            if (storeId) {
                appLoader.classList.remove('hidden');
                supervisorDashboard.classList.add('hidden'); // Esconde antes de carregar
                await loadStoreDataForAdmin(storeId);
                appLoader.classList.add('hidden');
                supervisorDashboard.classList.remove('hidden'); // Mostra depois de carregar
            } else {
                supervisorDashboard.classList.add('hidden');
                if(unsubscribeHistoryListener) unsubscribeHistoryListener();
            }
        });
    }

    // NOVO: Carrega os dados da loja para o Admin (similar ao loadSupervisor)
    async function loadStoreDataForAdmin(storeId) {
        const storeDoc = await getDoc(doc(db, 'stores', storeId));
        const storeData = storeDoc.exists() ? storeDoc.data() : { storeGoal: 0 };
        
        document.getElementById('sup-kpi-meta-loja').textContent = fmtBRL(storeData.storeGoal);
        document.getElementById('sup-meta-loja-input').value = storeData.storeGoal || 0;
        
        // Query por *LOJA* em vez de supervisor
        const sellersQuery = query(collection(db, 'users'), where("storeId", "==", storeId), where("role", "==", "seller"));
        const querySnapshot = await getDocs(sellersQuery);
        const sellers = querySnapshot.docs.map(d => ({ uid: d.id, ...d.data() }));

        const salesPromises = sellers.map(seller => getDoc(doc(db, "salesData", seller.uid)));
        const salesDocs = await Promise.all(salesPromises);
        currentTeamData = sellers.map((seller, i) => ({
            ...seller,
            salesData: salesDocs[i].exists() ? salesDocs[i].data() : { config: {}, sales: [] }
        }));
        
        renderSupervisorDashboard(currentTeamData, storeData);
        // Configura os botões de "Salvar Meta" e "Fechar Mês" para a loja selecionada
        setupSupervisorEventListeners(null, storeId, storeData); // Passa null para UID
    }
    
    // NOVO: Prepara o formulário para edição
    function prepareEditForm(uid) {
        const user = allUsers.find(u => u.id === uid);
        if (!user) {
            console.error("Usuário não encontrado para edição");
            return;
        }

        document.getElementById('admin-form-title').textContent = 'Editar Usuário';
        document.getElementById('admin-edit-uid').value = uid;
        document.getElementById('admin-userName').value = user.name;
        document.getElementById('admin-userEmail').value = user.email;
        document.getElementById('admin-userEmail').disabled = true; // Não permite trocar email
        document.getElementById('admin-userPassword').value = '';
        document.getElementById('admin-userPassword').disabled = true;
        document.getElementById('admin-userPassword').required = false;
        document.getElementById('admin-userPassword').placeholder = 'Use "Resetar Senha" na tabela';
        document.getElementById('admin-userRole').value = user.role;
        document.getElementById('admin-userStore').value = user.storeId;
        
        // Dispara a lógica de mostrar/esconder o seletor de supervisor
        document.getElementById('admin-userRole').dispatchEvent(new Event('change'));

        if (user.role === 'seller') {
            document.getElementById('admin-userSupervisor').value = user.supervisorUid;
        }

        document.getElementById('admin-create-user-btn').textContent = 'Salvar Alterações';
        document.getElementById('admin-cancel-edit-btn').classList.remove('hidden');
        
        // Rola a tela para o formulário
        document.getElementById('admin-form-title').scrollIntoView({ behavior: 'smooth' });
    }

    // NOVO: Reseta o formulário para o modo "Criar"
    function resetAdminForm() {
        document.getElementById('create-user-form').reset();
        document.getElementById('admin-form-title').textContent = 'Criar Novo Usuário';
        document.getElementById('admin-edit-uid').value = '';
        document.getElementById('admin-userEmail').disabled = false;
        document.getElementById('admin-userPassword').disabled = false;
        document.getElementById('admin-userPassword').required = true;
        document.getElementById('admin-userPassword').placeholder = 'Senha de 6+ dígitos';
        document.getElementById('admin-create-user-btn').textContent = 'Criar Conta';
        document.getElementById('admin-cancel-edit-btn').classList.add('hidden');
        document.getElementById('admin-supervisor-selector-div').classList.add('hidden');
        document.getElementById('admin-form-feedback').textContent = '';
    }
    
    // NOVO: Função para resetar senha
    async function handlePasswordReset(email) {
        if (!confirm(`Um email de redefinição de senha será enviado para ${email}. Deseja continuar?`)) {
            return;
        }
        try {
            await sendPasswordResetEmail(auth, email);
            alert('Email de redefinição enviado com sucesso!');
        } catch (error) {
            console.error("Erro ao resetar senha:", error);
            alert('Erro ao enviar email: ' + error.message);
        }
    }

    function updateAdminSupervisorDropdown() {
        const storeSelect = document.getElementById('admin-userStore');
        const supervisorSelect = document.getElementById('admin-userSupervisor');
        const selectedStore = storeSelect.value;
        
        supervisorSelect.innerHTML = '';
        
        if (!selectedStore) {
            supervisorSelect.innerHTML = '<option value="">Primeiro, selecione a loja</option>';
            return;
        }

        const filteredSupervisors = allSupervisors.filter(s => s.storeId === selectedStore);

        if (filteredSupervisors.length === 0) {
            supervisorSelect.innerHTML = '<option value="">Nenhum supervisor nesta loja</option>';
            return;
        }

        supervisorSelect.innerHTML = '<option value="">Selecione um supervisor</option>';
        filteredSupervisors.forEach(sup => {
            const option = document.createElement('option');
            option.value = sup.id;
            option.textContent = sup.name;
            supervisorSelect.appendChild(option);
        });
    }

    // ATUALIZADO: Renomeada de 'handleCreateUser' para 'handleSaveUser'
    async function handleSaveUser(e) {
      e.preventDefault();
      const form = e.target;
      const feedbackEl = document.getElementById('admin-form-feedback');
      const submitBtn = document.getElementById('admin-create-user-btn');
      
      const name = form['admin-userName'].value;
      const role = form['admin-userRole'].value;
      const storeId = form['admin-userStore'].value;
      const supervisorUid = form['admin-userSupervisor'].value;
      const editUid = form['admin-edit-uid'].value;
      const isEditMode = !!editUid;

      if (role === 'seller' && !supervisorUid) {
        feedbackEl.textContent = 'Por favor, selecione um supervisor para o vendedor.';
        feedbackEl.className = 'text-sm text-red-600';
        return;
      }
      
      submitBtn.disabled = true;

      try {
        if (isEditMode) {
            // LÓGICA DE EDIÇÃO
            feedbackEl.textContent = 'Atualizando usuário...';
            const userData = { name, role, storeId };
            if (role === 'seller') {
                userData.supervisorUid = supervisorUid;
            } else {
                 userData.supervisorUid = ''; // Remove supervisor se não for vendedor
            }
            
            await updateDoc(doc(db, "users", editUid), userData);
            
            feedbackEl.textContent = 'Usuário atualizado com sucesso!';
            feedbackEl.className = 'text-sm text-green-600';
            resetAdminForm(); // Reseta o formulário

        } else {
            // LÓGICA DE CRIAÇÃO (existente)
            feedbackEl.textContent = 'Criando usuário...';
            const email = form['admin-userEmail'].value;
            const password = form['admin-userPassword'].value;

            const tempApp = initializeApp(firebaseConfig, "secondary" + new Date().getTime());
            const tempAuth = getAuth(tempApp);
            const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
            const newUser = userCredential.user;

            const userData = { name, email, role, storeId };
            if (role === 'seller') {
                userData.supervisorUid = supervisorUid;
            }

            await setDoc(doc(db, "users", newUser.uid), userData);
            form.reset();
            document.getElementById('admin-supervisor-selector-div').classList.add('hidden');
            feedbackEl.textContent = 'Usuário criado com sucesso!';
            feedbackEl.className = 'text-sm text-green-600';
        }
      } catch (error) {
        if (isEditMode) {
             feedbackEl.textContent = 'Ocorreu um erro ao atualizar o usuário.';
        } else {
            if (error.code === 'auth/email-already-in-use') {
                feedbackEl.textContent = 'Erro: Este email já está cadastrado.';
            } else if (error.code === 'auth/weak-password') {
                feedbackEl.textContent = 'Erro: A senha precisa ter no mínimo 6 caracteres.';
            } else {
                feedbackEl.textContent = 'Ocorreu um erro ao criar o usuário.';
            }
        }
        feedbackEl.className = 'text-sm text-red-600';
      } finally {
        submitBtn.disabled = false;
        setTimeout(() => feedbackEl.textContent = '', 4000);
      }
    }

    // --- LÓGICA DO PAINEL DO SUPERVISOR ---
    let currentTeamData = [];
    async function loadSupervisorDashboard(uid, storeId, storeData) {
        document.getElementById('sup-kpi-meta-loja').textContent = fmtBRL(storeData.storeGoal);
        document.getElementById('sup-meta-loja-input').value = storeData.storeGoal || 0;
        setupSupervisorEventListeners(uid, storeId, storeData);

        // Query por *SUPERVISOR*
        const sellersQuery = query(collection(db, 'users'), where("supervisorUid", "==", uid));
        const querySnapshot = await getDocs(sellersQuery);
        const sellers = querySnapshot.docs.map(d => ({ uid: d.id, ...d.data() }));

        const salesPromises = sellers.map(seller => getDoc(doc(db, "salesData", seller.uid)));
        const salesDocs = await Promise.all(salesPromises);
        currentTeamData = sellers.map((seller, i) => ({
            ...seller,
            salesData: salesDocs[i].exists() ? salesDocs[i].data() : { config: {}, sales: [] }
        }));
        
        renderSupervisorDashboard(currentTeamData, storeData);
    }

    function renderSupervisorDashboard(teamData, storeData){
        let totalMetaEquipe = 0, totalVendidoEquipe = 0;
        const salesByDay = {}, today = new Date();
        const diasNoMes = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        const sellersTableBody = document.getElementById('sellers-table-body');
        sellersTableBody.innerHTML = '';
        
        teamData.forEach(seller => {
            const metaVendedor = seller.salesData.config?.metaMes || 0;
            let vendidoMesAtual = 0;
            (seller.salesData.sales || []).forEach(v => {
                const vendaDate = new Date(v.date + 'T12:00:00');
                if (vendaDate.getMonth() === today.getMonth() && vendaDate.getFullYear() === today.getFullYear()) {
                    vendidoMesAtual += v.amount;
                    salesByDay[v.date] = (salesByDay[v.date] || 0) + v.amount;
                }
            });
            totalMetaEquipe += metaVendedor;
            totalVendidoEquipe += vendidoMesAtual;
            const progresso = metaVendedor > 0 ? (vendidoMesAtual / metaVendedor) * 100 : 0;
            sellersTableBody.innerHTML += `<tr class="border-b hover:bg-slate-50 cursor-pointer" data-uid="${seller.uid}">
                <td class="p-3 font-medium">${seller.name}</td>
                <td class="p-3 text-right">${fmtBRL(metaVendedor)}</td>
                <td class="p-3 text-right font-semibold">${fmtBRL(vendidoMesAtual)}</td>
                <td class="p-3"><div class="flex items-center gap-2"><div class="w-full bg-slate-200 h-2.5 rounded-full"><div class="bg-indigo-600 h-2.5 rounded-full" style="width:${Math.min(100,progresso)}%"></div></div><span class="text-xs">${progresso.toFixed(0)}%</span></div></td>
            </tr>`;
        });
        
        document.getElementById('sup-kpi-meta-equipe').textContent = fmtBRL(totalMetaEquipe);
        document.getElementById('sup-kpi-vendido-total').textContent = fmtBRL(totalVendidoEquipe);
        const progressoGeral = totalMetaEquipe > 0 ? (totalVendidoEquipe / totalMetaEquipe) * 100 : 0;
        document.getElementById('sup-kpi-progresso-total').textContent = `${progressoGeral.toFixed(1)}%`;
        
        // ATUALIZADO: Chama 'renderChart' e armazena a instância
        storeChart = renderChart('storeChart', salesByDay, totalMetaEquipe, diasNoMes, storeChart);
        
        appLoader.classList.add('hidden');
        supervisorDashboard.classList.remove('hidden'); // Assegura que está visível
    }

    function setupSupervisorEventListeners(uid, storeId, storeData) {
        // Remove listeners antigos para evitar duplicação
        const saveBtn = document.getElementById('sup-save-meta-loja');
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        newSaveBtn.onclick = async () => {
            const newGoal = Number(document.getElementById('sup-meta-loja-input').value);
            const feedbackEl = document.getElementById('sup-meta-feedback');
            if (newGoal >= 0) {
                await setDoc(doc(db, 'stores', storeId), { storeGoal: newGoal }, { merge: true });
                feedbackEl.textContent = 'Meta da loja atualizada!';
                feedbackEl.className = 'text-sm mt-2 text-green-600';
            } else {
                feedbackEl.textContent = 'Valor inválido.';
                feedbackEl.className = 'text-sm mt-2 text-red-600';
            }
            setTimeout(() => feedbackEl.textContent = '', 3000);
        };

        const tableBody = document.getElementById('sellers-table-body');
        const newTableBody = tableBody.cloneNode(false); // Limpa listeners antigos
        tableBody.parentNode.replaceChild(newTableBody, tableBody);
        newTableBody.onclick = (e) => {
            const row = e.target.closest('tr');
            if (!row) return;
            const sellerData = currentTeamData.find(s => s.uid === row.dataset.uid);
            if (sellerData) showChartModal(`Desempenho de ${sellerData.name}`, sellerData);
        };
        // Repopula a tabela (necessário após clonar)
        newTableBody.innerHTML = document.getElementById('sellers-table-body').innerHTML;


        const closeBtn = document.getElementById('sup-close-month-btn');
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
        newCloseBtn.onclick = () => handleCloseMonth(storeId, currentTeamData, storeData);
        
        // Limpa listener de histórico antes de adicionar um novo
        if(unsubscribeHistoryListener) unsubscribeHistoryListener();
        loadAndRenderHistory(storeId);
    }
    
    async function handleCloseMonth(storeId, teamData, storeData) {
        if (!confirm('Tem certeza que deseja fechar o mês? Esta ação é irreversível e irá zerar as vendas de todos os vendedores.')) return;
        
        const today = new Date();
        const monthId = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        const monthLabel = today.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
        
        let totalVendidoEquipe = 0;
        const salesByDay = {};
        teamData.forEach(seller => {
            (seller.salesData.sales || []).forEach(v => {
                const vendaDate = new Date(v.date + 'T12:00:00');
                if (vendaDate.getMonth() === today.getMonth() && vendaDate.getFullYear() === today.getFullYear()) {
                    totalVendidoEquipe += v.amount;
                    salesByDay[v.date] = (salesByDay[v.date] || 0) + v.amount;
                }
            });
        });
        
        const historyData = {
            monthLabel,
            storeGoal: storeData.storeGoal,
            totalSales: totalVendidoEquipe,
            progress: storeData.storeGoal > 0 ? (totalVendidoEquipe / storeData.storeGoal) * 100 : 0,
            salesByDay,
            createdAt: new Date()
        };
        
        try {
            await setDoc(doc(db, 'stores', storeId, 'history', monthId), historyData);
            const batch = writeBatch(db);
            teamData.forEach(seller => {
                batch.update(doc(db, 'salesData', seller.uid), { sales: [] });
            });
            await batch.commit();
            alert('Mês fechado e arquivado com sucesso!');
            
            // Recarrega os dados da loja para o admin, se for o admin
            if(document.getElementById('header-title').textContent === 'Painel Administrativo') {
                await loadStoreDataForAdmin(storeId);
            } else {
                location.reload(); // Recarrega a página para o supervisor
            }
        } catch (error) {
            console.error("Erro ao fechar o mês: ", error);
            alert("Ocorreu um erro ao fechar o mês.");
        }
    }

    function loadAndRenderHistory(storeId) {
        const historyRef = collection(db, 'stores', storeId, 'history');
        unsubscribeHistoryListener = onSnapshot(historyRef, (snapshot) => {
            const container = document.getElementById('history-table-container');
            if(snapshot.empty) {
                container.innerHTML = '<p class="text-sm text-slate-500">Nenhum mês fechado ainda.</p>';
                return;
            }
            let tableHTML = `<table class="min-w-full text-sm text-left">
                <thead class="bg-slate-100"><tr>
                    <th class="p-3 font-medium">Mês</th>
                    <th class="p-3 font-medium text-right">Meta (R$)</th>
                    <th class="p-3 font-medium text-right">Vendido (R$)</th>
                    <th class="p-3 font-medium text-right">Progresso</th>
                    <th class="p-3 font-medium text-center">Ações</th>
                </tr></thead><tbody>`;
            
            const historyDocs = snapshot.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.id.localeCompare(a.id));

            historyDocs.forEach(h => {
                tableHTML += `<tr class="border-b">
                    <td class="p-3 capitalize">${h.monthLabel}</td>
                    <td class="p-3 text-right">${fmtBRL(h.storeGoal)}</td>
                    <td class="p-3 text-right font-semibold">${fmtBRL(h.totalSales)}</td>
                    <td class="p-3 text-right">${h.progress.toFixed(1)}%</td>
                    <td class="p-3 text-center space-x-2">
                        <button class="text-blue-600 hover:underline view-history-btn" data-id="${h.id}">Ver Gráfico</button>
                        <button class="text-red-600 hover:underline delete-history-btn" data-id="${h.id}">Excluir</button>
                    </td>
                </tr>`;
            });
            container.innerHTML = tableHTML + '</tbody></table>';
        });
        
        // Limpa listener antigo
        const historyContainer = document.getElementById('history-table-container');
        const newHistoryContainer = historyContainer.cloneNode(true);
        historyContainer.parentNode.replaceChild(newHistoryContainer, historyContainer);
        
        newHistoryContainer.onclick = async (e) => {
            const target = e.target;
            const historyId = target.dataset.id;
            if(!historyId) return;

            if(target.classList.contains('view-history-btn')){
                const historyDoc = await getDoc(doc(db, 'stores', storeId, 'history', historyId));
                if(historyDoc.exists()){
                    const data = historyDoc.data();
                    const diasNoMes = new Date(parseInt(historyId.split('-')[0]), parseInt(historyId.split('-')[1]), 0).getDate();
                    showChartModal(`Desempenho de ${data.monthLabel}`, { salesByDay: data.salesByDay, totalMeta: data.storeGoal, diasNoMes });
                }
            }
            if(target.classList.contains('delete-history-btn')){
                if(confirm(`Tem certeza que deseja excluir o histórico de ${historyId}?`)){
                    await deleteDoc(doc(db, 'stores', storeId, 'history', historyId));
                }
            }
        };
    }
    
    // ATUALIZADO: A variável 'storeChart' é definida globalmente no escopo do supervisor
    let storeChart; 
    let modalChart;
    
    function renderChart(canvasId, salesByDay, totalMeta, diasNoMes, existingChart) {
        const labels = Array.from({ length: diasNoMes }, (_, i) => i + 1);
        const dailyTotals = new Array(diasNoMes).fill(0);
        Object.keys(salesByDay).sort().forEach(date => {
            const day = parseInt(date.split('-')[2], 10) - 1;
            if (day >= 0 && day < diasNoMes) dailyTotals[day] = salesByDay[date];
        });
        const accumulatedReal = dailyTotals.reduce((acc, val) => [...acc, (acc.length > 0 ? acc[acc.length - 1] : 0) + val], []);
        const metaDiariaIdeal = (totalMeta || 0) / (diasNoMes || 1);
        const accumulatedIdeal = labels.map(day => metaDiariaIdeal * day);
        
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (existingChart) {
            existingChart.destroy(); // Destrói o gráfico anterior
        }
        
        // Retorna a nova instância do gráfico
        return new Chart(ctx, { 
            type: 'line', 
            data: { 
                labels, 
                datasets: [
                    { label: 'Acumulado Real', data: accumulatedReal, borderColor: '#4338ca', backgroundColor: '#4338ca20', fill: true, tension: 0.1 }, 
                    { label: 'Acumulado Ideal', data: accumulatedIdeal, borderColor: '#be123c', borderDash: [5, 5], fill: false }
                ] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: {
                    y: { ticks: { callback: (value) => fmtBRL(value) } },
                    x: { ticks: { maxTicksLimit: 15 } }
                },
                plugins: {
                    tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${fmtBRL(context.raw)}` } }
                }
            }
        });
    }

    function showChartModal(title, data) {
        const modal = document.getElementById('chart-modal');
        document.getElementById('modal-chart-title').textContent = title;
        
        let chartData;
        if(data.salesData) { // É um vendedor individual do mês atual
            const { config, sales } = data.salesData;
            const salesByDay = {};
            (sales || []).forEach(sale => {
                const vendaDate = new Date(sale.date + 'T12:00:00');
                const today = new Date();
                // Filtra apenas vendas do mês atual
                if (vendaDate.getMonth() === today.getMonth() && vendaDate.getFullYear() === today.getFullYear()) {
                    salesByDay[sale.date] = (salesByDay[sale.date] || 0) + sale.amount;
                }
            });
            chartData = { salesByDay, totalMeta: config?.metaMes, diasNoMes: config?.diasMes };
        } else { // É um histórico
            chartData = data;
        }

        modalChart = renderChart('modalChartCanvas', chartData.salesByDay, chartData.totalMeta, chartData.diasNoMes, modalChart);
        modal.classList.remove('hidden');
        document.getElementById('modal-close-btn').onclick = () => modal.classList.add('hidden');
        modal.onclick = (e) => { if(e.target === modal) modal.classList.add('hidden'); };
    }

    // --- LÓGICA DO PAINEL DO VENDEDOR ---
    let sellerChart;
    function loadSellerDashboard(uid, storeData) {
        document.getElementById('seller-kpi-meta-loja').textContent = fmtBRL(storeData.storeGoal);
        const salesDocRef = doc(db, 'salesData', uid);
        
        if(unsubscribeSalesListener) unsubscribeSalesListener();
        unsubscribeSalesListener = onSnapshot(salesDocRef, (doc) => {
            const today = new Date();
            const diasNoMes = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const diaAtual = today.getDate();
            
            const salesData = doc.exists() 
                ? doc.data() 
                : { config: { metaMes: 0, diasMes: diasNoMes, diaAtual: diaAtual }, sales: [] };
            
            // Garante que a configuração padrão seja usada se não houver config
            if (!salesData.config) {
                salesData.config = { metaMes: 0, diasMes: diasNoMes, diaAtual: diaAtual };
            }
                
            renderSellerDashboard(salesData);
        });
        setupSellerEventListeners(uid);
        appLoader.classList.add('hidden');
        sellerDashboard.classList.remove('hidden');
    }

    function renderSellerDashboard(data) {
        const { config, sales } = data;
        const { metaMes, diasMes, diaAtual } = config;
        
        const today = new Date();
        const defaultDiasMes = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        const defaultDiaAtual = today.getDate();

        document.getElementById('seller-meta-mes').value = metaMes || 0;
        document.getElementById('seller-dias-mes').value = diasMes || defaultDiasMes;
        document.getElementById('seller-dia-atual').value = diaAtual || defaultDiaAtual;

        // Filtra vendas apenas do mês e ano atuais
        const currentMonthSales = (sales || []).filter(sale => {
            const saleDate = new Date(sale.date + 'T12:00:00');
            return saleDate.getMonth() === today.getMonth() && saleDate.getFullYear() === today.getFullYear();
        });

        const vendidoAteAgora = currentMonthSales.reduce((sum, sale) => sum + sale.amount, 0);
        const metaDiaria = (metaMes || 0) / (diasMes || 1);
        const ritmoXIdeal = vendidoAteAgora - (metaDiaria * (diaAtual || defaultDiaAtual));
        const progresso = (metaMes || 0) > 0 ? (vendidoAteAgora / metaMes) : 0;
        
        document.getElementById('seller-kpi-meta-diaria').textContent = fmtBRL(metaDiaria);
        document.getElementById('seller-kpi-vendido').textContent = fmtBRL(vendidoAteAgora);
        
        const diasRestantes = Math.max((diasMes || defaultDiasMes) - (diaAtual || defaultDiaAtual), 0);
        const necessarioHoje = Math.max(metaMes - vendidoAteAgora, 0);
        
        document.getElementById('seller-kpi-necessario').textContent = fmtBRL(diasRestantes > 0 ? (necessarioHoje / diasRestantes) : (necessarioHoje > 0 ? necessarioHoje : 0));
        document.getElementById('seller-kpi-ritmo').textContent = (ritmoXIdeal >= 0 ? '+' : '') + fmtBRL(ritmoXIdeal);
        document.getElementById('seller-kpi-ritmo').className = 'text-xl font-semibold ' + (ritmoXIdeal >= 0 ? 'text-emerald-600' : 'text-rose-600');
        document.getElementById('seller-kpi-progresso').textContent = `${(progresso * 100).toFixed(1)}%`;
        document.getElementById('seller-progress-fill').style.width = Math.min(100, progresso * 100) + '%';
        
        const tableBody = document.getElementById('seller-sales-table');
        tableBody.innerHTML = '';
        currentMonthSales.forEach((sale, index) => {
             // Dando um ID único baseado na posição original do array 'sales'
             const originalIndex = sales.findIndex(s => s.date === sale.date && s.amount === sale.amount && !s.processed);
             if (originalIndex > -1) sales[originalIndex].processed = true; // Marca como processado para evitar duplicatas
             
             tableBody.innerHTML += `<tr class="border-b"><td class="p-2">${sale.date.split('-').reverse().join('/')}</td><td class="p-2 text-right">${fmtBRL(sale.amount)}</td><td class="p-2 text-center"><button data-index="${originalIndex}" class="remove-sale-btn text-rose-500 hover:underline text-xs">X</button></td></tr>`;
        });
        
        // Limpa as marcas 'processed'
        sales.forEach(s => delete s.processed);
        
        const salesByDay = {};
        currentMonthSales.forEach(s => { salesByDay[s.date] = (salesByDay[s.date] || 0) + s.amount; });
        sellerChart = renderChart('sellerChart', salesByDay, metaMes, diasMes, sellerChart);
    }

    function setupSellerEventListeners(uid){
        const salesDocRef = doc(db, 'salesData', uid);
        document.getElementById('seller-save-cfg').onclick = async () => {
            const newConfig = {
                metaMes: Number(document.getElementById('seller-meta-mes').value) || 0,
                diasMes: Number(document.getElementById('seller-dias-mes').value) || 30,
                diaAtual: Number(document.getElementById('seller-dia-atual').value) || new Date().getDate(),
            };
            await setDoc(salesDocRef, { config: newConfig }, { merge: true });
        };
        document.getElementById('seller-add-sale').onclick = async () => {
            const date = document.getElementById('seller-sale-date').value;
            const amount = Number(document.getElementById('seller-sale-amount').value);
            if (!date || amount <= 0) { alert('Data ou valor inválidos.'); return; }
            
            const saleDate = new Date(date + 'T12:00:00');
            const today = new Date();
            if(saleDate.getMonth() !== today.getMonth() || saleDate.getFullYear() !== today.getFullYear()) {
                if(!confirm('A data desta venda não pertence ao mês atual. Deseja registrar mesmo assim?')) {
                    return;
                }
            }
            
            const docSnap = await getDoc(salesDocRef);
            const currentSales = docSnap.exists() ? (docSnap.data().sales || []) : [];
            await setDoc(salesDocRef, { sales: [...currentSales, { date, amount }] }, { merge: true });
            document.getElementById('seller-sale-amount').value = '';
        };
        document.getElementById('seller-sales-table').onclick = async (e) => {
            if (e.target.classList.contains('remove-sale-btn')) {
                const indexToRemove = parseInt(e.target.dataset.index, 10);
                if(isNaN(indexToRemove)) return;
                
                const docSnap = await getDoc(salesDocRef);
                const currentSales = docSnap.data().sales || [];
                const newSales = currentSales.filter((_, i) => i !== indexToRemove);
                await updateDoc(salesDocRef, { sales: newSales });
            }
        };
        
        // Define valores padrão ao carregar
        const today = new Date();
        document.getElementById('seller-sale-date').valueAsDate = today;
        
        const configDiasMes = document.getElementById('seller-dias-mes').value;
        const configDiaAtual = document.getElementById('seller-dia-atual').value;
        
        if (!configDiasMes || configDiasMes === "0") {
             document.getElementById('seller-dias-mes').value = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        }
        if (!configDiaAtual || configDiaAtual === "0") {
            document.getElementById('seller-dia-atual').value = today.getDate();
        }
    }
  </script>
</body>
</html>
