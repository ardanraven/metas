<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Meta Mensal de Vendas</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .progress-bar { transition: width 400ms ease; }
    .table-wrap { max-height: 360px; overflow: auto; }
    /* Estilos para o spinner de carregamento */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- TELA DE LOGIN -->
  <div id="login-view" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-lg">
      <div>
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          Acessar Painel de Metas
        </h2>
      </div>
      <form id="login-form" class="mt-8 space-y-6">
        <div class="rounded-md shadow-sm -space-y-px">
          <div>
            <label for="email" class="sr-only">Email</label>
            <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email">
          </div>
          <div>
            <label for="password" class="sr-only">Senha</label>
            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Senha">
          </div>
        </div>
        <p id="login-error" class="text-sm text-red-600 mt-2"></p>
        <div>
          <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Entrar
          </button>
        </div>
      </form>
      <div class="text-sm text-center">
        <p>Não tem uma conta?
          <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">
            Crie uma agora
          </a>
        </p>
      </div>
    </div>
  </div>

  <!-- TELA DE REGISTRO -->
  <div id="register-view" class="min-h-screen items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8 hidden">
      <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-lg">
        <div>
          <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
            Criar Nova Conta
          </h2>
        </div>
        <form id="register-form" class="mt-8 space-y-6">
           <div>
              <label for="email-address" class="sr-only">Email</label>
              <input id="register-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Email">
            </div>
            <div>
              <label for="password" class="sr-only">Senha</label>
              <input id="register-password" name="password" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Senha (mínimo 6 caracteres)">
            </div>
          <p id="register-error" class="text-sm text-red-600 mt-2"></p>
          <div>
            <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              Registrar
            </button>
          </div>
        </form>
         <div class="text-sm text-center">
            <p>Já tem uma conta?
            <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">
                Faça o login
            </a>
            </p>
        </div>
      </div>
    </div>


  <!-- TELA PRINCIPAL DA APLICAÇÃO -->
  <div id="app-view" class="max-w-6xl mx-auto p-6 hidden">
    <header class="mb-6 flex flex-wrap justify-between items-center">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Controle de Meta Mensal de Vendas</h1>
        <p id="user-email" class="text-sm text-slate-500">Carregando...</p>
      </div>
      <button id="logout-btn" class="px-4 py-2 mt-2 md:mt-0 rounded-xl bg-rose-600 text-white text-sm hover:bg-rose-700">Sair</button>
    </header>

    <!-- SPINNER DE CARREGAMENTO -->
    <div id="app-loader" class="flex justify-center items-center py-10">
      <div class="loader"></div>
    </div>

    <!-- CONTEÚDO DO PAINEL -->
    <div id="app-content" class="hidden">
      <!-- Configurações -->
      <section class="bg-white rounded-2xl shadow p-5 grid md:grid-cols-3 gap-4">
        <div class="md:col-span-1">
          <label class="block text-sm font-medium">Meta do mês (R$)</label>
          <input id="metaMes" type="number" inputmode="decimal" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="75000" />
          <input id="metaMesSlider" type="range" min="10000" max="100000" step="1000" class="w-full mt-2 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
          <p class="text-xs text-slate-500 mt-1">Use o slider para metas de vendedor ou digite qualquer valor.</p>
        </div>
        <div>
          <label class="block text-sm font-medium">Dias no mês</label>
          <input id="diasMes" type="number" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="30" />
        </div>
        <div>
          <label class="block text-sm font-medium">Dia atual do mês</label>
          <input id="diaAtual" type="number" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="md:col-span-3 flex flex-wrap gap-2 pt-1">
          <button id="saveCfg" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm hover:bg-emerald-700">Salvar configurações</button>
          <button id="resetAll" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">Limpar vendas</button>
        </div>
      </section>

      <!-- KPIs -->
      <section class="grid md:grid-cols-4 gap-4 mt-6">
        <div class="bg-white rounded-2xl shadow p-5">
          <p class="text-xs text-slate-500">Meta diária</p>
          <p id="kpiMetaDiaria" class="text-xl font-semibold">R$ 0,00</p>
        </div>
        <div class="bg-white rounded-2xl shadow p-5">
          <p class="text-xs text-slate-500">Vendido até agora</p>
          <p id="kpiVendido" class="text-xl font-semibold">R$ 0,00</p>
        </div>
        <div class="bg-white rounded-2xl shadow p-5">
          <p class="text-xs text-slate-500">Necessário por dia</p>
          <p id="kpiNecessarioDia" class="text-xl font-semibold">R$ 0,00</p>
        </div>
        <div class="bg-white rounded-2xl shadow p-5">
          <p class="text-xs text-slate-500">Ritmo × Ideal</p>
          <p id="kpiRitmo" class="text-xl font-semibold">R$ 0,00</p>
        </div>
      </section>

      <!-- Progresso -->
      <section class="bg-white rounded-2xl shadow p-5 mt-6">
        <div class="flex items-center justify-between">
          <p class="text-sm font-medium">Progresso da meta</p>
          <p id="kpiProgresso" class="text-sm font-semibold">0%</p>
        </div>
        <div class="w-full h-3 bg-slate-200 rounded-full mt-2">
          <div id="progressFill" class="h-3 bg-indigo-600 rounded-full progress-bar" style="width:0%"></div>
        </div>
        <p id="alerta" class="mt-3 text-sm"></p>
      </section>

      <!-- Registro de vendas -->
      <section class="bg-white rounded-2xl shadow p-5 mt-6 grid md:grid-cols-3 gap-4">
        <div class="md:col-span-1">
          <h2 class="text-lg font-semibold">Registrar venda</h2>
          <div class="mt-3 space-y-3">
            <div>
              <label class="block text-sm font-medium">Data</label>
              <input id="saleDate" type="date" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="block text-sm font-medium">Valor (R$)</label>
              <input id="saleAmount" type="text" inputmode="decimal" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex.: 20000 ou 20.000,00" />
            </div>
            <div class="flex items-center gap-2">
              <button id="addSale" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-700">Adicionar</button>
              <button id="removeLast" class="px-4 py-2 rounded-xl bg-rose-600 text-white text-sm hover:bg-rose-700">Desfazer última</button>
            </div>
            <p class="text-xs text-slate-500">Você pode lançar várias vendas no mesmo dia; somamos automaticamente.</p>
          </div>
        </div>
        <div class="md:col-span-2">
          <h2 class="text-lg font-semibold">Vendas lançadas</h2>
          <div class="table-wrap mt-3">
            <table class="min-w-full text-sm">
              <thead class="sticky top-0 bg-slate-100">
                <tr>
                  <th class="text-left p-2 font-medium">Data</th>
                  <th class="text-right p-2 font-medium">Valor (R$)</th>
                  <th class="text-right p-2 font-medium">Acumulado</th>
                  <th class="p-2"></th>
                </tr>
              </thead>
              <tbody id="salesTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Gráfico -->
      <section class="bg-white rounded-2xl shadow p-5 mt-6">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Vendas por dia — comparativo com ideal</h2>
          <div class="flex gap-2">
            <button id="downloadCSV" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-800 text-xs hover:bg-slate-300">Baixar CSV</button>
            <button id="printView" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-800 text-xs hover:bg-slate-300">Imprimir/Salvar PDF</button>
          </div>
        </div>
        <canvas id="salesChart" class="mt-4"></canvas>
      </section>

      <footer class="text-xs text-slate-400 mt-8 text-center">Dados salvos na nuvem com Firebase.</footer>
    </div>
  </div>

  <!-- Scripts do Firebase -->
  <script type="module">
    // Importações do Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAVEpjwrF4t_Z1MPt5hR1YYuEv2-x7rQqk",
      authDomain: "painel-metas-6cb79.firebaseapp.com",
      projectId: "painel-metas-6cb79",
      storageBucket: "painel-metas-6cb79.firebasestorage.app",
      messagingSenderId: "980825522055",
      appId: "1:980825522055:web:d1f1f5609ed0e1c9079d22"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentUser = null;
    let unsubscribeFromData = null; // Função para parar de ouvir as atualizações do Firestore

    // ===== Lógica de Autenticação e UI =====
    const loginView = document.getElementById('login-view');
    const registerView = document.getElementById('register-view');
    const appView = document.getElementById('app-view');
    const appLoader = document.getElementById('app-loader');
    const appContent = document.getElementById('app-content');
    
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');

    showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginView.classList.add('hidden');
        registerView.classList.remove('hidden');
        registerView.classList.add('flex');
    });

    showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        registerView.classList.add('hidden');
        registerView.classList.remove('flex');
        loginView.classList.remove('hidden');
    });

    // Formulário de Login
    const loginForm = document.getElementById('login-form');
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      errorEl.textContent = '';

      signInWithEmailAndPassword(auth, email, password)
        .catch(error => {
          console.error("Erro de login:", error.code, error.message);
          errorEl.textContent = 'Email ou senha inválidos.';
        });
    });
    
    // Formulário de Registro
    const registerForm = document.getElementById('register-form');
    registerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const errorEl = document.getElementById('register-error');
      errorEl.textContent = '';

      createUserWithEmailAndPassword(auth, email, password)
        .catch(error => {
          console.error("Erro de registro:", error.code, error.message);
          if (error.code === 'auth/weak-password') {
            errorEl.textContent = 'A senha precisa ter no mínimo 6 caracteres.';
          } else if (error.code === 'auth/email-already-in-use') {
            errorEl.textContent = 'Este email já está em uso.';
          } else {
            errorEl.textContent = 'Ocorreu um erro ao criar a conta.';
          }
        });
    });

    // Botão de Logout
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn.addEventListener('click', () => {
        signOut(auth);
    });

    // Monitoramento do estado de autenticação
    onAuthStateChanged(auth, user => {
      if (user) {
        // Usuário está logado
        currentUser = user;
        loginView.classList.add('hidden');
        registerView.classList.add('hidden');
        appView.classList.remove('hidden');
        document.getElementById('user-email').textContent = `Usuário: ${user.email}`;
        
        // Se já houver uma escuta ativa, cancele-a antes de iniciar uma nova
        if (unsubscribeFromData) {
            unsubscribeFromData();
        }
        loadData();

      } else {
        // Usuário está deslogado
        currentUser = null;
        loginView.classList.remove('hidden');
        registerView.classList.add('hidden');
        appView.classList.add('hidden');
        appContent.classList.add('hidden');
        appLoader.classList.remove('hidden');

        // Cancela a escuta dos dados quando o usuário desloga
        if (unsubscribeFromData) {
            unsubscribeFromData();
            unsubscribeFromData = null;
        }
      }
    });

    // ===== Util =====
    const fmtBRL = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const pct = (v) => (v * 100).toFixed(2).replace('.', ',') + '%';
    const pad = (n) => String(n).padStart(2, '0');
    const today = new Date();
    const isoDate = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    const toBR = (iso) => { const [y, m, d] = iso.split('-'); return `${d}/${m}/${y}`; }
    function parseBRNumber(txt) {
      if (typeof txt !== 'string') txt = String(txt ?? '');
      txt = txt.trim().replace(/\./g, '').replace(/,/g, '.');
      const n = Number(txt);
      return isNaN(n) ? 0 : n;
    }

    // ===== Estado =====
    let state;
    const defaultState = {
      config: { metaMes: 75000, diasMes: new Date(today.getFullYear(), today.getMonth()+1, 0).getDate(), diaAtual: today.getDate() },
      sales: [] // {date:'YYYY-MM-DD', amount:Number}
    };
    
    // Função para salvar os dados no Firestore
    async function save() {
      if (!currentUser) return;
      try {
        const userDocRef = doc(db, 'userData', currentUser.uid);
        await setDoc(userDocRef, state);
      } catch (error) {
        console.error("Erro ao salvar dados: ", error);
        alert("Não foi possível salvar os dados. Verifique sua conexão.");
      }
    }

    // Função para carregar os dados do Firestore em tempo real
    function loadData() {
        if (!currentUser) return;
        appLoader.classList.remove('hidden');
        appContent.classList.add('hidden');

        const userDocRef = doc(db, 'userData', currentUser.uid);
        
        unsubscribeFromData = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                state = docSnap.data();
            } else {
                // Se não existem dados para o usuário, cria com o padrão
                console.log("Nenhum dado encontrado, criando documento padrão.");
                state = JSON.parse(JSON.stringify(defaultState)); // Deep copy
                save(); // Salva o estado inicial
            }
            hydrateUI();
            appLoader.classList.add('hidden');
            appContent.classList.remove('hidden');
        }, (error) => {
            console.error("Erro ao carregar dados em tempo real:", error);
            alert("Erro ao carregar os dados. Tente recarregar a página.");
        });
    }

    // ===== UI refs =====
    const metaMes = document.getElementById('metaMes');
    const metaMesSlider = document.getElementById('metaMesSlider');
    const diasMes = document.getElementById('diasMes');
    const diaAtual = document.getElementById('diaAtual');
    const saveCfg = document.getElementById('saveCfg');
    const resetAll = document.getElementById('resetAll');
    
    const kpiMetaDiaria = document.getElementById('kpiMetaDiaria');
    const kpiVendido = document.getElementById('kpiVendido');
    const kpiNecessarioDia = document.getElementById('kpiNecessarioDia');
    const kpiRitmo = document.getElementById('kpiRitmo');
    const kpiProgresso = document.getElementById('kpiProgresso');
    const progressFill = document.getElementById('progressFill');
    const alerta = document.getElementById('alerta');

    const saleDate = document.getElementById('saleDate');
    const saleAmount = document.getElementById('saleAmount');
    const addSale = document.getElementById('addSale');
    const removeLast = document.getElementById('removeLast');
    const salesTable = document.getElementById('salesTable');

    const downloadCSV = document.getElementById('downloadCSV');
    const printView = document.getElementById('printView');
    
    // ===== Chart =====
    let chart;
    function buildChart(labels, daily, idealAccum, realAccum) {
      const ctx = document.getElementById('salesChart');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Vendas do dia', data: daily, backgroundColor: 'rgba(79, 70, 229, 0.8)' },
            { type: 'line', label: 'Acumulado real', data: realAccum, tension: 0.25, borderColor: 'rgba(5, 150, 105, 1)', backgroundColor: 'rgba(5, 150, 105, 0.2)' },
            { type: 'line', label: 'Acumulado ideal', data: idealAccum, borderDash: [6, 6], tension: 0.25, borderColor: 'rgba(225, 29, 72, 1)', backgroundColor: 'rgba(225, 29, 72, 0.2)' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { position: 'bottom' } }
        }
      });
      if(ctx.parentElement) {
        ctx.parentElement.style.height = '360px';
      }
    }

    // ===== Lógica Principal =====
    function hydrateUI() {
      if (!state) return;
      metaMes.value = state.config.metaMes;
      metaMesSlider.value = state.config.metaMes;
      diasMes.value = state.config.diasMes;
      diaAtual.value = state.config.diaAtual;
      saleDate.value = isoDate(new Date());
      saleAmount.value = '';
      render();
    }

    function totalsByDay() {
      const map = {};
      if (!state || !state.sales) return [];
      for (const s of state.sales) {
        map[s.date] = (map[s.date] || 0) + Number(s.amount || 0);
      }
      return Object.entries(map).sort((a, b) => a[0].localeCompare(b[0]));
    }

    function render() {
      if (!state) return;
      const { metaMes: meta, diasMes: dias, diaAtual: dia } = state.config;
      const rows = totalsByDay();
      
      const now = new Date();
      const monthNow = now.getMonth() + 1;
      const yearNow = now.getFullYear();

      const labels = Array.from({ length: dias }, (_, i) => (i + 1).toString());
      const perDay = new Array(dias).fill(0);
      
      // Filtra vendas para o mês e ano corrente
      for (const [dateISO, amount] of rows) {
        const [y, m, d] = dateISO.split('-').map(Number);
        if (y === yearNow && m === monthNow) {
          const idx = d - 1;
          if (idx >= 0 && idx < perDay.length) perDay[idx] += amount;
        }
      }
      
      const realAccum = [];
      const idealAccum = [];
      let running = 0;
      const metaDiaria = meta / (dias || 1);
      for (let i = 0; i < dias; i++) {
        running += perDay[i];
        realAccum.push(running);
        idealAccum.push(metaDiaria * (i + 1));
      }

      const vendidoAteAgora = realAccum[Math.max(0, Math.min(dia - 1, realAccum.length - 1))] || 0;
      const faltaMeta = Math.max(meta - vendidoAteAgora, 0);
      const diasRestantes = Math.max(dias - dia, 0);
      const necessarioDia = diasRestantes > 0 ? faltaMeta / diasRestantes : 0;
      const ritmoXIdeal = vendidoAteAgora - (metaDiaria * dia);
      const progresso = meta > 0 ? (vendidoAteAgora / meta) : 0;
      
      kpiMetaDiaria.textContent = fmtBRL(metaDiaria || 0);
      kpiVendido.textContent = fmtBRL(vendidoAteAgora);
      kpiNecessarioDia.textContent = fmtBRL(necessarioDia);
      kpiRitmo.textContent = (ritmoXIdeal >= 0 ? '+' : '') + fmtBRL(ritmoXIdeal);
      kpiRitmo.className = 'text-xl font-semibold ' + (ritmoXIdeal >= 0 ? 'text-emerald-600' : 'text-rose-600');
      
      kpiProgresso.textContent = pct(progresso);
      progressFill.style.width = Math.min(100, progresso * 100) + '%';
      
      alerta.textContent = '';
      alerta.className = 'mt-3 text-sm';
      if (necessarioDia > metaDiaria * 1.3 && diasRestantes > 0) {
        alerta.textContent = 'Atenção: é preciso acelerar as vendas para alcançar a meta.';
        alerta.classList.add('text-rose-600');
      } else if (ritmoXIdeal > 0) {
        alerta.textContent = 'Parabéns! Você está acima do ritmo ideal.';
        alerta.classList.add('text-emerald-700');
      }

      salesTable.innerHTML = '';
      let acumulado = 0;
      for (const [dateISO, val] of rows) {
        acumulado += val;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${toBR(dateISO)}</td>
          <td class="p-2 text-right">${fmtBRL(val)}</td>
          <td class="p-2 text-right">${fmtBRL(acumulado)}</td>
          <td class="p-2 text-right"><button data-date="${dateISO}" class="text-rose-600 text-xs hover:underline">remover dia</button></td>
        `;
        salesTable.appendChild(tr);
      }
      
      buildChart(labels, perDay, idealAccum, realAccum);
    }

    // ===== Eventos =====
    metaMesSlider.addEventListener('input', (e) => {
        metaMes.value = e.target.value;
    });
    metaMes.addEventListener('input', (e) => {
        metaMesSlider.value = e.target.value;
    });

    saveCfg.addEventListener('click', () => {
      state.config.metaMes = Number(metaMes.value || 0);
      state.config.diasMes = Math.max(1, Number(diasMes.value || 30));
      state.config.diaAtual = Math.min(state.config.diasMes, Math.max(1, Number(diaAtual.value || new Date().getDate())));
      save(); // A renderização ocorrerá automaticamente pelo onSnapshot
    });

    resetAll.addEventListener('click', () => {
      // Usando um modal customizado simples em vez de confirm()
      if (window.confirm('Deseja apagar TODAS as vendas deste mês? As configurações serão mantidas.')) {
        state.sales = [];
        save();
      }
    });

    addSale.addEventListener('click', () => {
      const date = saleDate.value || isoDate(new Date());
      const amount = parseBRNumber(saleAmount.value);
      if (!amount || amount <= 0) {
          alert('Informe um valor de venda válido (ex.: 20000 ou 20.000,00).');
          return;
      }
      if(!state.sales) state.sales = [];
      state.sales.push({ date, amount });
      save();
      saleAmount.value = '';
      saleAmount.focus();
    });
    saleAmount.addEventListener('keyup', (e) => { if(e.key==='Enter') addSale.click() });

    removeLast.addEventListener('click', () => {
      if (!state.sales || state.sales.length === 0) return;
      state.sales.pop();
      save();
    });

    salesTable.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-date]');
      if (!btn) return;
      const dateISO = btn.getAttribute('data-date');
      state.sales = state.sales.filter(s => s.date !== dateISO);
      save();
    });

    downloadCSV.addEventListener('click', () => {
      if (!state || !state.sales || state.sales.length === 0) {
        alert("Não há vendas para exportar.");
        return;
      }
      const rows = [['Data', 'Valor']];
      for (const s of state.sales) rows.push([s.date, s.amount]);
      const csv = rows.map(r => r.join(';')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `vendas_${currentUser.email}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    printView.addEventListener('click', () => window.print());

    // Inicialização dos campos de data
    diaAtual.value = today.getDate();
    diasMes.value = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    saleDate.value = isoDate(today);

  </script>
</body>
</html>
